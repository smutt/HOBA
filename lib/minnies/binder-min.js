/*
 * @file user.js
 * @brief a "do all that's needed script"
 */
function hoba_bindTo(a){var b=new XMLHttpRequest();var c=hoba_make_auth_header();b.open("GET","/.well-known/hoba/binding-res?btype=res&bv="+a,false);b.setRequestHeader("Authorization","HOBA "+c);b.onload=function(){var d=new Date()};b.send(null)}function hoba_register(h){var a=0;var i=get_origin();var g=get_tbsorigin();privstruct=hoba_get_key(i,a);if(!ismsie&&privstruct==false){hobatext("waiting key generation completion - will try again in a second");setTimeout(function(){hoba_register(h)},1000);return false}if(privstruct.state!="new"&&privstruct.state!="reginwork"){if(privstruct.state="regok"){hobatext("Already registered dude.");hoba_bindTo(h);hoba_login();hoba_show_state()}else{hobatext("Weirdness in registration.")}return}var c="-----BEGIN PUBLIC KEY-----";var f=urlb64(hex2b64(hoba_get_spki(privstruct.rsa)));f=add0D0As(f);var d="-----END PUBLIC KEY-----";var b=c+"%0D%0A"+f+"%0D%0A"+d;var e="&kidtype="+privstruct.kidalg+"&kidval="+urlb64(privstruct.kid)+"&didtype=2&didval=youpick&pub="+b;regreq=new XMLHttpRequest();var j="/.well-known/hoba/register";regreq.onload=function(){if(regreq.readyState==4&&regreq.status==200){hobatext(regreq.responseText);privstruct.state="regok";privstruct.time=new Date();hoba_put_key(privstruct.origin,privstruct,privstruct.alg);hoba_bindTo(h);hoba_login();hoba_show_state()}else{if(regreq.readyState==4&&regreq.status>=400){privstruct.state="reginwork";privstruct.time=new Date();hoba_put_key(privstruct.origin,privstruct,privstruct.alg);hobatext(regreq.responseText)}}hoba_show_state()};regreq.open("POST",j,true);regreq.setRequestHeader("Content-type","application/x-www-form-urlencoded");regreq.send(e)}function getqrv(){var a=window.location.search.substr(1);var c=a.split("&");var e={};for(var b=0;b<c.length;b++){var d=c[b].split("=");e[d[0]]=d[1];if(d[0]=="qrv"){return d[1]}}return("dunno")}var cgstarted=false;function checkGen(){if(cgstarted){return}cgstarted=true;hoba_checkUA();if(localStorage){var a=hoba_getpriv();if(a==null){setTimeout(checkGen,200)}}hoba_register(getqrv())}window.onload=function(){if(!window.document.body){window.document.body.onload=checkGen}else{checkGen()}};